<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>마카샤 시뮬레이터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            box-sizing: border-box;
        }
        body {
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        #ui-layer {
            position: relative;
            z-index: 100;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .score-container {
            border: 5px solid #8FC1B5;
            background-color: white;
        }
        .score-text {
            color: #8FC1B5;
        }
        .click-target {
            transition: transform 0.05s ease-out;
            cursor: pointer;
            -webkit-user-drag: none;
        }
        .click-target:active {
            transform: scale(0.92);
        }
        .falling-item {
            position: absolute;
            top: -50px;
            width: 80px; 
            height: auto;
            pointer-events: none;
            z-index: 50;
            will-change: transform;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(calc(100vh + 50px)) rotate(360deg); opacity: 0; }
        }
        .upgrade-btn {
            background-color: white;
            border: 2px solid #8FC1B5;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        /* 호버 시 내부의 모든 텍스트 색상을 흰색으로 강제 변경 */
        .upgrade-btn:hover:not(:disabled) {
            background-color: #8FC1B5 !important;
            color: white !important;
        }
        .upgrade-btn:hover:not(:disabled) span, 
        .upgrade-btn:hover:not(:disabled) div {
            color: white !important;
        }
        .upgrade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* 랭크업 알림 스타일 */
        #rank-toast {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(143, 193, 181, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateY(100px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
            opacity: 0;
            pointer-events: none;
        }
        #rank-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        #help-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center; align-items: center;
            pointer-events: auto;
        }
        #estate-tab {
            position: fixed; right: -320px; top: 0;
            width: 320px; height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 200;
            padding: 20px; display: flex; flex-direction: column;
            pointer-events: auto;
        }
        #estate-tab.open { right: 0; }
        #estate-toggle {
            position: absolute; left: -50px; top: 50%;
            transform: translateY(-50%);
            width: 50px; height: 100px;
            background: #8FC1B5; color: white;
            writing-mode: vertical-rl; text-orientation: upright;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border-radius: 15px 0 0 15px;
            cursor: pointer;
        }
        .estate-item {
            border: 2px solid #eee; border-radius: 15px;
            padding: 15px; margin-bottom: 15px; transition: all 0.3s;
        }
        .estate-item.owned { border-color: #8FC1B5; background-color: #fafffe; }
    </style>
</head>
<body>

    <div id="rank-toast">랭크 업!</div>

    <div id="help-modal">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full relative m-4">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b-2 border-[#8FC1B5] pb-2">도움말</h2>
            <p class="text-gray-600 leading-relaxed">
                춤추는 나를 누르면 포인트가 올라간다구!<br>근력을 강화하면 자동으로 랭크가 올라서 클릭 파워가 증폭돼!<br>랭크 4에서 5가 되려면 더 큰 노력이 필요할걸?<br>마지막 목표는 세계수 교단을 차지하는 거야!
            </p>
        </div>
    </div>

    <div id="estate-tab">
        <div id="estate-toggle">부동산</div>
        <h2 class="text-xl font-bold mb-6 text-gray-800 border-b-2 border-[#8FC1B5] pb-2">부동산 매물</h2>
        <div id="estate-list" class="overflow-y-auto"></div>
    </div>

    <div id="ui-layer">
        <div class="fixed top-8 left-12 p-6 rounded-2xl shadow-xl score-container min-w-[250px] text-center pointer-events-auto">
            <div class="text-xl font-bold text-gray-500 mb-1">이-히힛! 포인트</div>
            <div id="score" class="text-5xl font-black score-text">0</div>
            <div class="mt-2 flex justify-center gap-4 text-sm font-bold text-gray-400">
                <span>클릭: +<span id="display-click">1</span></span>
                <span>초당: +<span id="display-auto">0</span></span>
            </div>
            <div class="mt-1 text-xs font-bold text-orange-400">현재 랭크: <span id="display-rank">0</span> / 5</div>
        </div>

        <h1 class="text-3xl font-bold pt-10 text-gray-800">마카샤 시뮬레이터</h1>

        <div class="flex flex-col items-center mt-6">
            <div class="mb-6">
                <img id="danceButton" src="resources/dancing.gif" alt="dancing" class="click-target max-w-sm w-full rounded-2xl shadow-2xl pointer-events-auto">
            </div>

            <div class="flex flex-col gap-3 w-80 pointer-events-auto">
                <button id="upgrade1" class="upgrade-btn p-3 rounded-xl font-bold shadow-sm">
                    <div>근력 강화! (Lv.<span id="lv1">0</span>)</div>
                    <div class="text-xs text-blue-500" id="rank-info">다음 랭크까지: 25 Lv</div>
                    <div class="text-sm">비용: <span id="cost1">100</span>P</div>
                </button>
                <button id="upgrade2" class="upgrade-btn p-3 rounded-xl font-bold shadow-sm">
                    <div>새로운 결말! (Lv.<span id="lv2">0</span>)</div>
                    <div class="text-xs text-green-500" id="auto-info">현재 강화당 +10P</div>
                    <div class="text-sm">비용: <span id="cost2">100</span>P</div>
                </button>
                
                <button id="open-modal" class="mt-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-lg font-bold transition-colors">설명 보기</button>
            </div>
        </div>
    </div>

    <script>
        let score = 0;
        let up1Level = 0;
        let up1Cost = 100;
        let up2Level = 0;
        let up2Cost = 100;
        let up3Level = 0;

        function nFormat(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        function getClickPower() {
            let base = 1 + up1Level;
            let multiplier = 1;
            for(let i = 1; i <= up3Level; i++) {
                multiplier *= Math.pow(2, i);
            }
            return base * multiplier;
        }

        function getAutoPower() {
            let total = 0;
            for(let i = 1; i <= up2Level; i++) {
                if(i >= 90) total += 1000;
                else if(i >= 60) total += 200;
                else if(i >= 30) total += 50;
                else total += 10;
            }
            return total;
        }

        const estates = [
            { id: 0, name: "요정왕국 에르피엔", basePrice: 200000, currentVal: 200000, growth: 1000, reqLevel: 30, audio: "resources/에르핀 우는 소리.mp3", desc: "요정왕국 에르피엔이야!", owned: false },
            { id: 1, name: "마녀왕국 벨리티엔", basePrice: 500000, currentVal: 500000, growth: 4000, reqLevel: 60, audio: "resources/말도 안되는 결과가.mp3", desc: "어라? 이건 반역인가?", owned: false },
            { id: 2, name: "모나티엄", basePrice: 1500000, currentVal: 1500000, growth: 10000, reqLevel: 90, audio: "resources/예산이 부족했어.mp3", desc: "엘프들의 도시야!", owned: false },
            { 
                id: 3, 
                name: "세계수 교단", 
                basePrice: 927000000, 
                currentVal: 927000000, 
                growth: 5521, 
                reqLevel: 150, 
                audio: "resources/세계수시여.mp3", 
                desc: "내가 이제 대빵이다!", 
                owned: false,
                isSpecial: true 
            }
        ];

        const audioFiles = ['resources/이히힛1.mp3', 'resources/이히힛2.mp3', 'resources/이히힛3.mp3', 'resources/이히힛4.mp3'];
        const fallImages = ['resources/scared.gif', 'resources/smile.gif', 'resources/sex.gif'];

        function initEstates() {
            const list = document.getElementById('estate-list');
            list.innerHTML = '';
            estates.forEach(est => {
                const item = document.createElement('div');
                item.id = `estate-item-${est.id}`;
                item.className = `estate-item`;
                item.innerHTML = `
                    <div class="font-bold text-gray-800">${est.name}</div>
                    <div class="text-xs text-gray-500 my-1">${est.desc}</div>
                    <div class="text-[10px] text-orange-500 font-bold">상승률: +${nFormat(est.growth)}/s</div>
                    <div id="est-req-${est.id}" class="text-xs font-bold">요구 새로운 결말 Lv.${est.reqLevel}</div>
                    <div id="est-val-container-${est.id}" class="hidden">
                        <div class="text-sm font-black text-[#8FC1B5] mt-1">현재 가치: <span id="est-val-${est.id}">0</span>P</div>
                    </div>
                    <button id="est-btn-${est.id}" class="upgrade-btn w-full p-2 mt-2 rounded-lg text-sm font-bold"></button>
                `;
                list.appendChild(item);
                document.getElementById(`est-btn-${est.id}`).addEventListener('click', () => {
                    if (est.owned) sellEstate(est.id); else buyEstate(est.id);
                });
            });
        }

        // 랭크업 토스트 표시 함수
        function showRankToast(multiplier) {
            const toast = document.getElementById('rank-toast');
            toast.innerText = `랭크 업! ${multiplier}배 더 강해졌다구!`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateUI() {
            document.getElementById('score').innerText = nFormat(score);
            document.getElementById('display-click').innerText = nFormat(getClickPower());
            document.getElementById('display-auto').innerText = nFormat(getAutoPower());
            document.getElementById('display-rank').innerText = up3Level;
            document.getElementById('lv1').innerText = up1Level;
            document.getElementById('cost1').innerText = nFormat(up1Cost);
            document.getElementById('lv2').innerText = up2Level;
            document.getElementById('cost2').innerText = nFormat(up2Cost);

            const rankInfo = document.getElementById('rank-info');
            if(up3Level >= 5) {
                rankInfo.innerText = "최대 랭크 도달!";
                rankInfo.classList.remove('text-blue-500');
                rankInfo.classList.add('text-red-500');
            } else {
                let nextTarget = (up3Level < 4) ? (up3Level + 1) * 25 : 150;
                rankInfo.innerText = `다음 랭크까지: ${nextTarget - up1Level} Lv`;
                rankInfo.classList.add('text-blue-500');
            }

            const autoInfo = document.getElementById('auto-info');
            let nextInc = up2Level >= 89 ? 1000 : (up2Level >= 59 ? 200 : (up2Level >= 29 ? 50 : 10));
            autoInfo.innerText = `강화당 초당 +${nextInc}P`;

            document.getElementById('upgrade1').disabled = score < up1Cost;
            document.getElementById('upgrade2').disabled = score < up2Cost;

            updateEstateUI();
        }

        function updateEstateUI() {
            const allOthersOwned = estates.filter(e => !e.isSpecial).every(e => e.owned);
            estates.forEach(est => {
                const isLevelMet = up2Level >= est.reqLevel;
                const isConditionMet = est.isSpecial ? (isLevelMet && allOthersOwned) : isLevelMet;
                const item = document.getElementById(`estate-item-${est.id}`);
                const btn = document.getElementById(`est-btn-${est.id}`);
                const reqText = document.getElementById(`est-req-${est.id}`);
                
                if (est.owned) {
                    item.classList.add('owned');
                    document.getElementById(`est-val-container-${est.id}`).classList.remove('hidden');
                    document.getElementById(`est-val-${est.id}`).innerText = nFormat(est.currentVal);
                    btn.innerText = `판매 (${nFormat(est.currentVal)}P)`;
                } else {
                    item.classList.remove('owned');
                    document.getElementById(`est-val-container-${est.id}`).classList.add('hidden');
                    btn.innerText = `구매 (${nFormat(est.basePrice)}P)`;
                    btn.disabled = (score < est.basePrice || !isConditionMet);
                }
            });
        }

        function buyEstate(id) {
            const est = estates[id];
            const allOthersOwned = estates.filter(e => !e.isSpecial).every(e => e.owned);
            if (score >= est.basePrice && up2Level >= est.reqLevel && (est.isSpecial ? allOthersOwned : true) && !est.owned) {
                score -= est.basePrice;
                est.owned = true;
                est.currentVal = est.basePrice;
                new Audio(est.audio).play().catch(()=>{});
                updateUI();
            }
        }

        function sellEstate(id) {
            const est = estates[id];
            if (est.owned) {
                score += est.currentVal;
                est.owned = false;
                est.currentVal = est.basePrice;
                updateUI();
            }
        }

        function spawnFallingItem() {
            const img = document.createElement('img');
            img.src = fallImages[Math.floor(Math.random() * fallImages.length)];
            img.className = 'falling-item';
            img.style.left = Math.random() * 95 + 'vw';
            const duration = Math.random() * 1.5 + 1.5;
            img.style.animation = `fall ${duration}s linear forwards`;
            document.body.appendChild(img);
            setTimeout(() => img.remove(), 5000);
        }

        initEstates();

        document.getElementById('estate-toggle').addEventListener('click', () => {
            document.getElementById('estate-tab').classList.toggle('open');
        });

        document.getElementById('upgrade1').addEventListener('click', () => {
            if (score >= up1Cost) {
                score -= up1Cost;
                up1Level++;
                up1Cost *= 1.1;
                
                // 랭크 로직 및 토스트 알림
                let oldRank = up3Level;
                if (up1Level < 100) {
                    up3Level = Math.floor(up1Level / 25);
                } else if (up1Level >= 150) {
                    up3Level = 5;
                } else {
                    up3Level = 4;
                }

                if (up3Level > oldRank) {
                    showRankToast(Math.pow(2, up3Level));
                }
                
                new Audio('resources/아 여기서 더 강해지다니.mp3').play().catch(()=>{});
                updateUI();
            }
        });

        document.getElementById('upgrade2').addEventListener('click', () => {
            if (score >= up2Cost) {
                score -= up2Cost;
                up2Level++;
                up2Cost *= 1.1;
                new Audio('resources/새로운 이야기를 쓸때가 왔어.mp3').play().catch(()=>{});
                updateUI();
            }
        });

        document.getElementById('danceButton').addEventListener('click', (e) => {
            e.preventDefault();
            score += getClickPower();
            new Audio(audioFiles[Math.floor(Math.random() * audioFiles.length)]).play().catch(()=>{});
            spawnFallingItem();
            updateUI();
        });

        let worldTreeTimer = 0;
        setInterval(() => {
            score += getAutoPower();
            worldTreeTimer++;
            estates.forEach(est => {
                if (est.owned) {
                    est.currentVal += est.growth;
                    if(est.isSpecial && worldTreeTimer >= 10) est.growth += 5521;
                }
            });
            if(worldTreeTimer >= 10) worldTreeTimer = 0;
            updateUI();
        }, 1000);

        setInterval(updateUI, 100);
        document.getElementById('open-modal').addEventListener('click', () => document.getElementById('help-modal').style.display = 'flex');
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('help-modal').style.display = 'none');
        window.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('dragstart', e => e.preventDefault());
    </script>
</body>
</html>